#include <stdio.h>
#include <pthread.h>
#include <unistd.h>
pthread_mutex_t mutex1=PTHREAD_MUTEX_INITIALIZER;
pthread_mutex_t mutex2=PTHREAD_MUTEX_INITIALIZER;
pthread_mutex_t mutex3=PTHREAD_MUTEX_INITIALIZER;
pthread_mutex_t mutex4=PTHREAD_MUTEX_INITIALIZER;
int t1_count=0,t2_count=0,t3_count=0,t4_count=0;
int exit_flag=0;
pthread_t tid1,tid2,tid3,tid4;
 
void* thread3(void* arg) {
    while(!exit_flag){
        pthread_mutex_lock(&mutex3);
        t3_count++;
        printf("t3 count: %d\n",t3_count);
        if(t3_count==5){
            t3_count=0;
            pthread_cancel(tid4);
            pthread_cancel(tid3);
        }
        pthread_mutex_unlock(&mutex3);
        sleep(1);
    }
    pthread_exit(NULL);
}
 
void* thread4(void* arg) {
    while(!exit_flag){
        pthread_mutex_lock(&mutex4);
        t4_count++;
        printf("t4 count: %d\n",t4_count);
        if(t4_count==5){
            pthread_create(&tid3,NULL,thread3,NULL);
            t4_count=0;
        }
        pthread_mutex_unlock(&mutex4);
        sleep(1);
    }
    pthread_exit(NULL);
}
 
void* thread2(void* arg) {
    while(!exit_flag){
        sleep(1);
    }
    pthread_exit(NULL);
}
 
void* thread1(void* arg) {
    while(!exit_flag){
        pthread_mutex_lock(&mutex1);
        t1_count++;
        printf("t1 count: %d\n",t1_count);
        if(t1_count==10){
            pthread_create(&tid4,NULL,thread4,NULL);
        }
        if(t1_count==20){
            pthread_create(&tid2,NULL,thread2,NULL);
            t2_count++;
            printf("t2 count: %d\n",t2_count);
            if(t2_count==5){
                exit_flag=1;
            }
            t1_count=0;
            t4_count=0;
            t3_count=0;
        }
        pthread_mutex_unlock(&mutex1);
        sleep(1);
    }
    pthread_exit(NULL);
}


int main() {
    pthread_create(&tid1,NULL,thread1,NULL);
    pthread_join(tid1,NULL);
    pthread_join(tid2,NULL);
    pthread_join(tid3,NULL);
    pthread_join(tid4,NULL);
    printf("all threads terminated\n");
    return 0;
}
